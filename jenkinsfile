#!groovy

node {

  options {
      ansiColor('xterm')
    }   

  stage ('Checkout') {
    checkout scm
  }

  stage ('Terraform Check') {
    def fmtStatus = sh "terraform fmt -list=true -write=false -diff=true -check=true"
      if (fmtStatus == 0) {
        echo "All correct"
      } else {
        echo "Changes necessary"
    }
  }

  stage ('Terraform Plan') {
    sh 'terraform plan -out=create.tfplan'
  }

  // Optional wait for approval
  // input 'Deploy stack?'

#  stage ('Terraform Apply') {
#    sh 'terraform apply create.tfplan'
#  }
#
#  stage ('Post Run Tests') {
#    echo "Insert your infrastructure test of choice and/or application validation here."
#    sleep 2
#    sh 'terraform show'
#  }
#
#  stage ('Notification') {
#    mail from: "vijayasree.r@sainsburys.co.uk",
#         to: "vijayasree.r@sainsburys.co.uk",
#         subject: "Terraform build complete",
#         body: "Jenkins job ${env.JOB_NAME} - build ${env.BUILD_NUMBER} complete"
#  }
}
